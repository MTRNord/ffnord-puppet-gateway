#!/bin/bash
# this script checks Maintenance mode and Gateway mide
# and checks if those services are running:
# isc-dhcp-server radvd ntp openvpn rpcbind fastd bind9 bird6 bird alfred batadv-vis named tincd

. /etc/ffnord

R="\033[31m" #red
G="\033[32m" #green
W="\033[39m" #white


GWM=$(cat /sys/class/net/*/mesh/gw_mode)
MAINTENANCE=${MAINTENANCE:-0}
if test $MAINTENANCE -eq 0; then
  echo -e $G"Maintenance is OFF"$W
  if [ "$GWM" == "server" ]; then
    echo -e $G"Gateway mode is $GWM"$W
  else
    echo -e $R"Gateway mode is $GWM"$W
  fi
else
  echo -e $R"Maintenance is ON"$W" since $(date --date=date -d @${MAINTENANCE})"
  if [ "$GWM" == "off" ]; then
    echo -e $G"Gateway mode is $GWM"$W
  else
    echo -e $R"Gateway mode is $GWM"$W
  fi
fi


#service --status-all 2>&1 | egrep '(openvpn|fastd|bat|bind|dhcp)'
# check for services if running by status
for s in isc-dhcp-server radvd; do
  echo "==>" $s "status"
  service $s status >/dev/null
  if [ $? -eq 0 ]; then 
    if test $MAINTENANCE -eq 0; then
      echo -e "[ "$G"ok"$W" ] $s is running"
    else 
      echo -e "["$R"FAIL"$W"] $s is running although MAINTENANCE is ON ... "$R'failed!'$W
    fi
  else
    echo -e -n "["$R"FAIL"$W"] $s is not running ... "
    if test $MAINTENANCE -eq 0; then
      echo -e $R'failed!'$W
    else
      echo -e $G"ok"$W
    fi
  fi
done
# check for services if running
for s in ntp openvpn rpcbind fastd bind9; do
    echo "==>" $s "status"
    service $s status
done

for s in bird6 bird alfred batadv-vis named tincd; do
  echo "==>" $s "status"
  if pgrep \\b$s\\b > /dev/null; then 
    echo -e "[ "$G"ok"$W" ] $s is running"
  else
    echo -e "["$R"FAIL"$W"] $s is not running ... "$R'failed!'$W
  fi
done
